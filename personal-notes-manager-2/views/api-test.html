<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notes Manager - Dashboard</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        :root {
        --primary-color: #4CAF50;
        --secondary-color: #2196F3;
        --danger-color: #f44336;
        --bg-dark: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e0e0e0;
    }

        body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center; 
    }

        .container { padding: 20px; }

       
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .note-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border-top: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }

        .note-card:hover { transform: translateY(-5px); }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-tag {
            background: #333;
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .note-card h3 { margin: 10px 0; color: #fff; }
        .note-card p { color: #bbb; line-height: 1.6; font-size: 0.95rem; }

        .card-actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }

        /* Формы */
        .api-section {
            background: var(--card-bg);
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #888; }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-edit { background: var(--secondary-color); color: white; }
        .btn-delete { background: var(--danger-color); color: white; }
        .btn:hover { opacity: 0.8; }

        .search-bar {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .hidden-id { color: #555; font-size: 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <header>
        <h1>Personal Notes Dashboard</h1>
        <nav>
            <a href="/">Home</a>
            <a href="/api-test" style="background: var(--primary-color); color: white; padding: 5px 10px; border-radius: 4px;">Refresh Data</a>
        </nav>
    </header>

    <div class="container">
        <section class="api-section">
            <h3 id="form-title"> Create New Note</h3>
            <form id="noteForm">
                <input type="hidden" id="noteId">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" required placeholder="Note title...">
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="content" required placeholder="Note content..."></textarea>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option value="general">General</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="study">Study</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">Create Note</button>
                <button type="button" class="btn" id="cancelBtn" style="display:none; background:#444;" onclick="resetForm()">Cancel</button>
            </form>
        </section>

        <section class="api-section">
            <h3> Search & Filters</h3>
            <div class="search-bar">
                <div class="form-group">
                    <label>Keyword</label>
                    
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="filterCategory" onchange="getAllNotes()">
                        <option value="">All Categories</option>
                        <option value="general">General</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="study">Study</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sort By</label>
                    <select id="sortBy" onchange="getAllNotes()">
                        <option value='{"createdAt":-1}'>Newest First</option>
                        <option value='{"createdAt":1}'>Oldest First</option>
                        <option value='{"title":1}'>Title A-Z</option>
                    </select>
                </div>
                <button onclick="getAllNotes()" class="btn btn-edit" style="margin-bottom:15px;">Refresh</button>
            </div>
        </section>

        <div id="notesContainer" class="notes-grid">
            </div>
    </div>

    <script>
        const API_URL = '/api/notes';

      
        async function getAllNotes() {
            const category = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchText').value;
            const sort = document.getElementById('sortBy').value;

            let url = `${API_URL}?`;
            if (category) url += `category=${category}&`;
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (sort) url += `sort=${encodeURIComponent(sort)}&`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                renderNotes(data.notes || data);
            } catch (err) {
                console.error("Failed to fetch notes:", err);
            }
        }

        function renderNotes(notes) {
            const container = document.getElementById('notesContainer');
            container.innerHTML = '';

            if (!notes || notes.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No notes found matching your criteria.</p>';
                return;
            }

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = `
                    <div class="note-header">
                        <span class="category-tag">${note.category || 'general'}</span>
                        <small style="color:#666">${new Date(note.createdAt).toLocaleDateString()}</small>
                    </div>
                    <h3>${note.title}</h3>
                    <p>${note.content}</p>
                    <div class="hidden-id">ID: ${note._id}</div>
                    <div class="card-actions">
                        <button onclick="editNote('${note._id}', '${note.title.replace(/'/g, "\\'")}', '${note.content.replace(/'/g, "\\'")}', '${note.category}')" class="btn btn-edit">Edit</button>
                        <button onclick="deleteNote('${note._id}')" class="btn btn-delete">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('noteId').value;
            const payload = {
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                category: document.getElementById('category').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    resetForm();
                    getAllNotes();
                }
            } catch (err) {
                alert("Error saving note");
            }
        });

        
        async function deleteNote(id) {
            if (confirm('Delete this note forever?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                getAllNotes();
            }
        }

        
        function editNote(id, title, content, category) {
            document.getElementById('noteId').value = id;
            document.getElementById('title').value = title;
            document.getElementById('content').value = content;
            document.getElementById('category').value = category;
            
            document.getElementById('form-title').innerText = " Update Note";
            document.getElementById('submitBtn').innerText = "Update Note";
            document.getElementById('cancelBtn').style.display = "inline-block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('noteId').value = '';
            document.getElementById('noteForm').reset();
            document.getElementById('form-title').innerText = " Create New Note";
            document.getElementById('submitBtn').innerText = "Create Note";
            document.getElementById('cancelBtn').style.display = "none";
        }

        
        window.onload = getAllNotes;
    </script>
</body>
</html>